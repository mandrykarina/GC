// ============================================
// UNIFIED MAIN - –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
// ============================================

#include <iostream>
#include <cstdlib>
#include <limits>
#include <memory>
#include "common_utils.h"
#include "mark_sweep_gc.h"
#include "cascade_deletion_gc.h"
#include "rc_heap.h"
#include "event_logger.h"
#include "rc_logger.h"
// –û–±—ä—è–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–π
extern int rc_main_interactive();
extern int ms_main_interactive();
// ============================================
// –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
// ============================================

void print_main_menu()
{
    std::cout << "\n";
    std::cout << "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
    std::cout << "‚ïë        UNIFIED GARBAGE COLLECTOR SIMULATOR v3.0           ‚ïë\n";
    std::cout << "‚ïë     –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Reference Counting –∏ Mark & Sweep           ‚ïë\n";
    std::cout << "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n";
    std::cout << "‚ïë 1) Reference Counting (RC)                                ‚ïë\n";
    std::cout << "‚ïë    –ë—ã—Å—Ç—Ä–æ, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏         ‚ïë\n";
    std::cout << "‚ïë                                                           ‚ïë\n";
    std::cout << "‚ïë 2) Mark & Sweep (MS)                                     ‚ïë\n";
    std::cout << "‚ïë    –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–∏–∫–ª—ã              ‚ïë\n";
    std::cout << "‚ïë                                                           ‚ïë\n";
    std::cout << "‚ïë 3) –û–ë–ê –°–ë–û–†–©–ò–ö–ê –°–†–ê–ó–£ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫)              ‚ïë\n";
    std::cout << "‚ïë    –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚ïë\n";
    std::cout << "‚ïë                                                           ‚ïë\n";
    std::cout << "‚ïë 0) –í—ã—Ö–æ–¥                                                 ‚ïë\n";
    std::cout << "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n";
}

void clear_input_buffer()
{
    std::cin.clear();
    std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n');
}

// ============================================
// –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û–ì–û –ó–ê–ü–£–°–ö–ê –û–ë–û–ò–• GC
// ============================================

void run_both_gc_simultaneously(const MemoryConfig &config)
{
    std::cout << "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
    std::cout << "–ü–ê–†–ê–õ–õ–ï–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö –î–í–£–• –°–ë–û–†–©–ò–ö–û–í –ú–£–°–û–†–ê\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";

    // ============================================
    // –í–´–ë–û–† –¢–ò–ü–ê –°–¶–ï–ù–ê–†–ò–Ø
    // ============================================
    std::cout << "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è:\n";
    std::cout << "1. –õ–∏–Ω–µ–π–Ω–∞—è —Ü–µ–ø—å (–ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–µ–∑ —Ü–∏–∫–ª–æ–≤)\n";
    std::cout << "2. –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —É—Ç–µ—á–µ–∫ –≤ RC)\n";
    std::cout << "3. –ö–∞—Å–∫–∞–¥–Ω–æ–µ –¥–µ—Ä–µ–≤–æ\n";
    std::cout << "–í–∞—à –≤—ã–±–æ—Ä (1-3): ";

    int scenario_type;
    std::cin >> scenario_type;
    clear_input_buffer();

    std::string scenario_name;

    switch (scenario_type)
    {
    case 1:
        scenario_name = "–õ–∏–Ω–µ–π–Ω–∞—è —Ü–µ–ø—å";
        break;
    case 2:
        scenario_name = "–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ";
        break;
    case 3:
        scenario_name = "–ö–∞—Å–∫–∞–¥–Ω–æ–µ –¥–µ—Ä–µ–≤–æ";
        break;
    default:
        std::cout << "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–Ω–µ–π–Ω—É—é —Ü–µ–ø—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.\n";
        scenario_name = "–õ–∏–Ω–µ–π–Ω–∞—è —Ü–µ–ø—å";
        scenario_type = 1;
    }

    std::cout << "\n–í—ã–±—Ä–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π: " << scenario_name << "\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";

    // ============================================
    // –ó–ê–ü–£–°–ö REFERENCE COUNTING
    // ============================================
    std::cout << "[–§–ê–ó–ê 1] –ó–ê–ü–£–°–ö REFERENCE COUNTING...\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

    auto rc_start = std::chrono::high_resolution_clock::now();

    {
        size_t heap_size = config.heap_size_bytes;
        // –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä –∏ –∫—É—á—É –¥–ª—è RC
        EventLogger logger("logs/simulation_events.log");
        RCLogger rc_logger("rc_log"); // ‚Üê –°–û–ó–î–ê–¢–¨ RC_LOGGER!
        RCHeap rc_heap(logger, rc_logger, heap_size);

        std::cout << "\n";
        std::cout << "–†–ï–ñ–ò–ú: Reference Counting\n";
        std::cout << "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n";
        std::cout << "  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤: " << config.num_objects << "\n";
        std::cout << "  ‚Ä¢ –†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞: " << config.object_size << " –±–∞–π—Ç\n";
        std::cout << "  ‚Ä¢ –†–∞–∑–º–µ—Ä –∫—É—á–∏: " << config.format_bytes(config.heap_size_bytes) << "\n";
        std::cout << "\n–í—ã–ø–æ–ª–Ω—è—é –æ–ø–µ—Ä–∞—Ü–∏–∏ " << scenario_name << "...\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

        // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è
        for (int i = 0; i < config.num_objects; ++i)
        {
            rc_heap.allocate(i, config.object_size);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å
        rc_heap.addroot(0);

        // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
        if (scenario_type == 1)
        { // –õ–∏–Ω–µ–π–Ω–∞—è —Ü–µ–ø—å
            for (int i = 1; i < config.num_objects; ++i)
            {
                rc_heap.addref(i - 1, i);
            }
        }
        else if (scenario_type == 2)
        { // –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ
            // –°–æ–∑–¥–∞–µ–º —Ü–∏–∫–ª: –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π, –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–∞ –ø–µ—Ä–≤—ã–π
            for (int i = 1; i < config.num_objects; ++i)
            {
                rc_heap.addref(i - 1, i);
            }
            // –ó–∞–º—ã–∫–∞–µ–º —Ü–∏–∫–ª
            rc_heap.addref(config.num_objects - 1, 0);
        }
        else if (scenario_type == 3)
        { // –ö–∞—Å–∫–∞–¥–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
            // –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π (–∫–∞–∫ –≤ –ª–∏–Ω–µ–π–Ω–æ–π —Ü–µ–ø–∏)
            for (int i = 1; i < config.num_objects; ++i)
            {
                rc_heap.addref(i - 1, i);
            }
        }

        // –£–¥–∞–ª—è–µ–º –∫–æ—Ä–µ–Ω—å
        rc_heap.removeroot(0);

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ RC
        size_t rc_objects_left = rc_heap.getheapsize();
        size_t rc_memory_freed = (config.num_objects - rc_objects_left) * config.object_size;

        auto rc_end = std::chrono::high_resolution_clock::now();
        double rc_execution_time = std::chrono::duration<double, std::milli>(rc_end - rc_start).count();

        // –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ RC
        std::cout << "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "–°–¢–ê–¢–ò–°–¢–ò–ö–ê REFERENCE COUNTING:\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –û–±—ä–µ–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:      " << config.num_objects << "\n";
        std::cout << "  –û–±—ä–µ–∫—Ç–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å:     " << rc_objects_left << "\n";
        std::cout << "  –ü–∞–º—è—Ç–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ:    " << rc_memory_freed << " –±–∞–π—Ç\n";
        std::cout << "  –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞:  " << (rc_objects_left * config.object_size) << " –±–∞–π—Ç\n";
        std::cout << "  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:      " << std::fixed << std::setprecision(3) << rc_execution_time << " –º—Å\n";

        if (rc_objects_left == 0)
        {
            std::cout << "  ‚úÖ –ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏\n";
        }
        else
        {
            std::cout << "  ‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–µ—á–∫–∞ (—Ü–∏–∫–ª—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è)\n";
        }
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
    }

    // ============================================
    // –ó–ê–ü–£–°–ö MARK & SWEEP
    // ============================================
    std::cout << "\n\n[–§–ê–ó–ê 2] –ó–ê–ü–£–°–ö MARK & SWEEP...\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

    auto ms_start = std::chrono::high_resolution_clock::now();

    {
        // –°–æ–∑–¥–∞–µ–º —Å–±–æ—Ä—â–∏–∫ Mark & Sweep
        auto ms_gc = std::make_unique<MarkSweepGC>(config.heap_size_bytes);

        std::cout << "\n";
        std::cout << "–†–ï–ñ–ò–ú: Mark & Sweep\n";
        std::cout << "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:\n";
        std::cout << "  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤: " << config.num_objects << "\n";
        std::cout << "  ‚Ä¢ –†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞: " << config.object_size << " –±–∞–π—Ç\n";
        std::cout << "  ‚Ä¢ –†–∞–∑–º–µ—Ä –∫—É—á–∏: " << config.format_bytes(config.heap_size_bytes) << "\n";
        std::cout << "\n–í—ã–ø–æ–ª–Ω—è—é –æ–ø–µ—Ä–∞—Ü–∏–∏ " << scenario_name << "...\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";

        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –∏—Ö ID
        std::vector<int> object_ids;
        for (int i = 0; i < config.num_objects; ++i)
        {
            int id = ms_gc->allocate(config.object_size);
            object_ids.push_back(id);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å
        if (auto *ms_ptr = dynamic_cast<MarkSweepGC *>(ms_gc.get()))
        {
            if (!object_ids.empty())
            {
                ms_ptr->make_root(object_ids[0]);
            }
        }

        // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è
        if (scenario_type == 1)
        { // –õ–∏–Ω–µ–π–Ω–∞—è —Ü–µ–ø—å
            for (size_t i = 1; i < object_ids.size(); ++i)
            {
                ms_gc->add_reference(object_ids[i - 1], object_ids[i]);
            }
        }
        else if (scenario_type == 2)
        { // –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ
            for (size_t i = 1; i < object_ids.size(); ++i)
            {
                ms_gc->add_reference(object_ids[i - 1], object_ids[i]);
            }
            // –ó–∞–º—ã–∫–∞–µ–º —Ü–∏–∫–ª
            ms_gc->add_reference(object_ids.back(), object_ids.front());
        }
        else if (scenario_type == 3)
        { // –ö–∞—Å–∫–∞–¥–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
            for (size_t i = 1; i < object_ids.size(); ++i)
            {
                ms_gc->add_reference(object_ids[i - 1], object_ids[i]);
            }
        }

        // –£–¥–∞–ª—è–µ–º –∫–æ—Ä–µ–Ω—å
        if (auto *ms_ptr = dynamic_cast<MarkSweepGC *>(ms_gc.get()))
        {
            if (!object_ids.empty())
            {
                ms_ptr->remove_root(object_ids[0]);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –º—É—Å–æ—Ä–∞
        size_t freed = ms_gc->collect();

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ MS
        size_t ms_objects_left = ms_gc->get_alive_objects_count();

        auto ms_end = std::chrono::high_resolution_clock::now();
        double ms_execution_time = std::chrono::duration<double, std::milli>(ms_end - ms_start).count();

        // –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ MS
        std::cout << "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "–°–¢–ê–¢–ò–°–¢–ò–ö–ê MARK & SWEEP:\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –û–±—ä–µ–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:      " << config.num_objects << "\n";
        std::cout << "  –û–±—ä–µ–∫—Ç–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å:     " << ms_objects_left << "\n";
        std::cout << "  –ü–∞–º—è—Ç–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ:    " << freed << " –±–∞–π—Ç\n";
        std::cout << "  –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞:  " << (ms_objects_left * config.object_size) << " –±–∞–π—Ç\n";
        std::cout << "  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:      " << std::fixed << std::setprecision(3) << ms_execution_time << " –º—Å\n";

        if (ms_objects_left == 0)
        {
            std::cout << "  ‚úÖ –í—Å—è –ø–∞–º—è—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞\n";
        }
        else
        {
            std::cout << "  ‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏\n";
        }
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
    }

    // ============================================
    // –ò–¢–û–ì–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
    // ============================================
    std::cout << "\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
    std::cout << "–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò:\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
    std::cout << "  ‚Ä¢ –°—Ü–µ–Ω–∞—Ä–∏–π:             " << scenario_name << "\n";
    std::cout << "  ‚Ä¢ –†–∞–∑–º–µ—Ä –∫—É—á–∏:          " << config.format_bytes(config.heap_size_bytes) << "\n";
    std::cout << "  ‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤:  " << config.num_objects << "\n";
    std::cout << "  ‚Ä¢ –†–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞:       " << config.object_size << " –±–∞–π—Ç\n";
    std::cout << "  ‚Ä¢ –û–±—â–∏–π –æ–±—ä–µ–º –ø–∞–º—è—Ç–∏:   " << config.format_bytes(config.calculate_used_memory()) << "\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
}

int main()
{
    int choice = -1;

    while (true)
    {
        print_main_menu();
        std::cout << "\n–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é (0-3): ";

        if (!(std::cin >> choice))
        {
            clear_input_buffer();
            std::cout << "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–≤–æ–¥!\n";
            continue;
        }

        switch (choice)
        {
        case 1:
            std::cout << "\nüìå –í—ã –≤—ã–±—Ä–∞–ª–∏: Reference Counting (RC)\n";
            std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            std::cout << "–ó–∞–ø—É—Å–∫ Reference Counting GC...\n";
            std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            rc_main_interactive();
            break;

        case 2:
            std::cout << "\nüìå –í—ã –≤—ã–±—Ä–∞–ª–∏: Mark & Sweep (MS)\n";
            std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            std::cout << "–ó–∞–ø—É—Å–∫ Mark & Sweep GC...\n";
            std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            ms_main_interactive();
            break;

        case 3:
            std::cout << "\nüìå –í—ã –≤—ã–±—Ä–∞–ª–∏: –û–ë–ê –°–ë–û–†–©–ò–ö–ê –°–†–ê–ó–£\n";
            std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
            {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑
                MemoryConfig config = interactive_memory_config();
                if (config.is_valid)
                {
                    print_configuration_summary(config);
                    run_both_gc_simultaneously(config);
                }
                else
                {
                    std::cout << "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è!\n";
                }
            }
            break;

        case 0:
            std::cout << "\nüëã –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GC Unified!\n";
            std::cout << "üö™ –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!\n\n";
            return 0;

        default:
            std::cout << "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä! –í–≤–µ–¥–∏—Ç–µ 0-3.\n";
            clear_input_buffer();
        }

        // –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        std::cout << "\n–ù–∞–∂–º–∏—Ç–µ ENTER —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å...";
        clear_input_buffer();
        std::cin.get();
    }

    return 0;
}
